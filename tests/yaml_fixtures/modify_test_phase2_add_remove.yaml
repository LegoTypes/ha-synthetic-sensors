version: "1.0"

global_settings:
  variables:
    main_power: sensor.house_power_meter
    main_voltage: sensor.house_voltage
    efficiency_factor: 0.92  # Changed from 0.95
    new_multiplier: 1.1      # Added new global variable
  device_identifier: test_device:modify_123

sensors:
  total_power:
    name: Total Power Consumption (Updated)
    entity_id: sensor.total_power_consumption
    formula: state("main_power") * efficiency_factor * new_multiplier  # Modified formula
    unit_of_measurement: W
    device_class: power
    state_class: measurement
    attributes:
      source_info:
        formula: "main_power"
        unit_of_measurement: "entity_id"
      efficiency_info:
        formula: "efficiency_factor * new_multiplier"
        unit_of_measurement: "multiplier"

  power_efficiency:
    name: Power Efficiency
    entity_id: sensor.power_efficiency
    formula: (state("main_power") * efficiency_factor) / state("main_power") * 100
    unit_of_measurement: "%"
    state_class: measurement
    attributes:
      calculation_method:
        formula: "efficiency_factor * 100"
        unit_of_measurement: "%"

  # voltage_monitor removed in this phase

  local_sensor:
    name: Local Sensor (No Globals)
    entity_id: sensor.local_sensor
    formula: state("local_var") + 15  # Changed offset from 10 to 15
    variables:
      local_var: sensor.local_temperature
    unit_of_measurement: "°C"
    device_class: temperature
    state_class: measurement
    attributes:
      offset_value:
        formula: "15"
        unit_of_measurement: "°C"

  complex_calculation:
    name: Complex Multi-Formula Sensor
    entity_id: sensor.complex_calculation
    formula: state("main_power") * 0.8
    unit_of_measurement: W
    device_class: power
    state_class: measurement
    attributes:
      phase_info:
        formula: "0.8"
        unit_of_measurement: "multiplier"
      voltage_percentage:
        formula: state("main_voltage") / 120 * 100
        variables:
          reference_voltage: 120
        unit_of_measurement: "%"

  # New sensors added in this phase
  new_power_factor:
    name: Power Factor Calculator
    entity_id: sensor.power_factor_calculator
    formula: state("main_power") / (state("main_voltage") * state("current_var"))
    variables:
      current_var: sensor.house_current
    unit_of_measurement: ""
    state_class: measurement
    attributes:
      calculation_type:
        formula: "power_factor"
        unit_of_measurement: "type"

  energy_cost:
    name: Energy Cost Estimator
    entity_id: sensor.energy_cost_estimator
    formula: (state("main_power") / 1000) * efficiency_factor * cost_per_kwh
    variables:
      cost_per_kwh: 0.12
    unit_of_measurement: "$/hr"
    state_class: measurement
    attributes:
      rate_info:
        formula: "cost_per_kwh"
        unit_of_measurement: "$/kWh"